import telebot
from telebot import types
import json
import os
import sqlite3
from datetime import datetime, timedelta
import logging

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('bot.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# Ð¢Ð¾ÐºÐµÐ½ (Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹, ÐºÐ°Ðº ÑƒÐºÐ°Ð·Ð°Ð½Ð¾)
TOKEN = '8127036562:AAHDyx_ygbhVOTXrQcAqRlifYStmb1vDLMA'
ADMIN_ID = 1707332723
DATABASE = 'store.db'

bot = telebot.TeleBot(TOKEN)


# =============================================
# Ð ÐÐ‘ÐžÐ¢Ð Ð¡ Ð‘ÐÐ—ÐžÐ™ Ð”ÐÐÐÐ«Ð¥
# =============================================

def init_db():
    """Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ Ð²ÑÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹, ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚"""
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()

    # Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð²Ð½ÐµÑˆÐ½Ð¸Ðµ ÐºÐ»ÑŽÑ‡Ð¸
    cursor.execute("PRAGMA foreign_keys = ON;")

    # Ð¢Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÑÐ¾Ð·Ð´Ð°ÑŽÑ‚ÑÑ Ð¿Ð¾ Ñ‚Ð²Ð¾ÐµÐ¼Ñƒ SQL
    schema_sql = """
    PRAGMA foreign_keys = ON;

    CREATE TABLE IF NOT EXISTS suppliers (
        id_supplier         INTEGER PRIMARY KEY AUTOINCREMENT,
        name                TEXT    NOT NULL,
        platform            TEXT    NOT NULL,
        contact_info        TEXT,
        min_order_value     REAL,
        shipping_method     TEXT,
        avg_delivery_days   INTEGER,
        active              INTEGER NOT NULL DEFAULT 1 CHECK (active IN (0, 1)),
        created_at          TEXT    NOT NULL DEFAULT (datetime('now', 'localtime'))
    );

    CREATE TABLE IF NOT EXISTS products (
        id_product          INTEGER PRIMARY KEY AUTOINCREMENT,
        name                TEXT    NOT NULL,
        description         TEXT,
        price_rub           REAL    NOT NULL CHECK (price_rub > 0),
        original_price_yuan REAL    NOT NULL,
        category            TEXT    DEFAULT 'Ð¾Ð±ÑƒÐ²ÑŒ',
        taobao_url          TEXT    NOT NULL,
        taobao_item_id      TEXT    NOT NULL UNIQUE,
        image_urls          TEXT,
        attributes          TEXT,
        last_updated        TEXT    NOT NULL DEFAULT (datetime('now', 'localtime')),
        created_at          TEXT    NOT NULL DEFAULT (datetime('now', 'localtime'))
    );

    CREATE TABLE IF NOT EXISTS customers (
        id_customer         INTEGER PRIMARY KEY AUTOINCREMENT,
        telegram_id         INTEGER NOT NULL UNIQUE,
        full_name           TEXT,
        username            TEXT,
        phone               TEXT,
        delivery_address    TEXT,
        city                TEXT,
        country             TEXT    NOT NULL DEFAULT 'Russia',
        language            TEXT    NOT NULL DEFAULT 'ru',
        created_at          TEXT    NOT NULL DEFAULT (datetime('now', 'localtime')),
        updated_at          TEXT    NOT NULL DEFAULT (datetime('now', 'localtime'))
    );

    CREATE TABLE IF NOT EXISTS user_sessions (
        id_session          INTEGER PRIMARY KEY AUTOINCREMENT,
        telegram_id         INTEGER NOT NULL,
        query               TEXT    NOT NULL,
        results_json        TEXT,
        status              TEXT    NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'completed', 'expired')),
        created_at          TEXT    NOT NULL DEFAULT (datetime('now', 'localtime')),
        expires_at          TEXT    NOT NULL DEFAULT (datetime('now', '+1 hour')),
        FOREIGN KEY (telegram_id) REFERENCES customers(telegram_id) ON DELETE CASCADE
    );

    CREATE TABLE IF NOT EXISTS cart (
        id_cart             INTEGER PRIMARY KEY AUTOINCREMENT,
        id_customer         INTEGER NOT NULL,
        id_product          INTEGER NOT NULL,
        size                TEXT,
        color               TEXT,
        quantity            INTEGER NOT NULL DEFAULT 1 CHECK (quantity >= 1 AND quantity <= 10),
        added_at            TEXT    NOT NULL DEFAULT (datetime('now', 'localtime')),
        FOREIGN KEY (id_customer) REFERENCES customers(id_customer) ON DELETE CASCADE,
        FOREIGN KEY (id_product) REFERENCES products(id_product) ON DELETE SET NULL,
        UNIQUE (id_customer, id_product, size, color)
    );

    CREATE TABLE IF NOT EXISTS orders (
        id_order            INTEGER PRIMARY KEY AUTOINCREMENT,
        id_customer         INTEGER NOT NULL,
        total_amount_rub    REAL    NOT NULL,
        currency            TEXT    NOT NULL DEFAULT 'RUB',
        order_date          TEXT    NOT NULL DEFAULT (datetime('now', 'localtime')),
        status              TEXT    NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'paid', 'processing_supplier', 'shipped', 'delivered', 'cancelled')),
        payment_status      TEXT    NOT NULL DEFAULT 'unpaid' CHECK (payment_status IN ('unpaid', 'paid', 'refunded')),
        payment_method      TEXT,
        delivery_address    TEXT    NOT NULL,
        tracking_number     TEXT,
        admin_note          TEXT,
        exchange_rate_used  REAL,
        FOREIGN KEY (id_customer) REFERENCES customers(id_customer) ON DELETE CASCADE
    );

    CREATE TABLE IF NOT EXISTS order_items (
        id_item             INTEGER PRIMARY KEY AUTOINCREMENT,
        id_order            INTEGER NOT NULL,
        id_product          INTEGER,
        product_name        TEXT    NOT NULL,
        product_price_rub   REAL    NOT NULL,
        size                TEXT,
        color               TEXT,
        quantity            INTEGER NOT NULL,
        subtotal            REAL    NOT NULL,
        FOREIGN KEY (id_order) REFERENCES orders(id_order) ON DELETE CASCADE,
        FOREIGN KEY (id_product) REFERENCES products(id_product) ON DELETE SET NULL
    );

    CREATE TABLE IF NOT EXISTS exchange_rates (
        id_rate             INTEGER PRIMARY KEY AUTOINCREMENT,
        rate_rub            REAL    NOT NULL,
        source              TEXT    DEFAULT 'manual',
        recorded_at         TEXT    NOT NULL DEFAULT (datetime('now', 'localtime'))
    );

    CREATE TABLE IF NOT EXISTS analytics (
        key                 TEXT    NOT NULL,
        value               TEXT    NOT NULL,
        recorded_at         TEXT    NOT NULL DEFAULT (datetime('now', 'localtime')),
        PRIMARY KEY (key, recorded_at)
    );

    -- Ð˜Ð½Ð´ÐµÐºÑÑ‹
    CREATE INDEX IF NOT EXISTS idx_products_taobao_id ON products(taobao_item_id);
    CREATE INDEX IF NOT EXISTS idx_products_category ON products(category);
    CREATE INDEX IF NOT EXISTS idx_products_name ON products(name);
    CREATE INDEX IF NOT EXISTS idx_customers_telegram_id ON customers(telegram_id);
    CREATE INDEX IF NOT EXISTS idx_user_sessions_telegram_id ON user_sessions(telegram_id);
    CREATE INDEX IF NOT EXISTS idx_user_sessions_expires_at ON user_sessions(expires_at);
    CREATE INDEX IF NOT EXISTS idx_cart_customer ON cart(id_customer);
    CREATE INDEX IF NOT EXISTS idx_orders_customer ON orders(id_customer);
    CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
    CREATE INDEX IF NOT EXISTS idx_orders_payment_status ON orders(payment_status);
    CREATE INDEX IF NOT EXISTS idx_orders_date ON orders(order_date);
    CREATE INDEX IF NOT EXISTS idx_order_items_order ON order_items(id_order);
    CREATE INDEX IF NOT EXISTS idx_exchange_rates_recorded_at ON exchange_rates(recorded_at);

    -- Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÑƒÑ€ÑÐ° ÑŽÐ°Ð½Ñ, ÐµÑÐ»Ð¸ Ð¿ÑƒÑÑ‚Ð¾
    cursor.execute("INSERT OR IGNORE INTO exchange_rates (rate_rub, source) VALUES (12.5, 'manual');")

    conn.commit()
    conn.close()
    logger.info("Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°")


# =============================================
# Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ Ð ÐÐ‘ÐžÐ¢Ð« Ð¡ ÐšÐ›Ð˜Ð•ÐÐ¢ÐÐœÐ˜
# =============================================

def register_or_update_customer(message):
    """Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°"""
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()

    full_name = f"{message.from_user.first_name} {message.from_user.last_name}".strip() if message.from_user.last_name else message.from_user.first_name
    username = message.from_user.username

    try:
        cursor.execute("""
            INSERT OR REPLACE INTO customers 
            (telegram_id, full_name, username, updated_at) 
            VALUES (?, ?, ?, datetime('now', 'localtime'))
            ON CONFLICT(telegram_id) DO UPDATE SET
                full_name = excluded.full_name,
                username = excluded.username,
                updated_at = excluded.updated_at
        """, (message.from_user.id, full_name, username))
        conn.commit()
    except Exception as e:
        logger.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: %s", e)
    finally:
        conn.close()


def get_customer(telegram_id):
    """ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°"""
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM customers WHERE telegram_id = ?", (telegram_id,))
    row = cursor.fetchone()
    conn.close()
    return dict(row) if row else None


# =============================================
# Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ Ð ÐÐ‘ÐžÐ¢Ð« Ð¡ ÐšÐžÐ Ð—Ð˜ÐÐžÐ™
# =============================================

def clear_expired_sessions():
    """Ð£Ð´Ð°Ð»ÑÐµÑ‚ Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð½Ñ‹Ðµ ÑÐµÑÑÐ¸Ð¸"""
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    cursor.execute("UPDATE user_sessions SET status = 'expired' WHERE expires_at < datetime('now')")
    conn.commit()
    conn.close()


# =============================================
# Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ Ð ÐÐ‘ÐžÐ¢Ð« Ð¡ Ð—ÐÐšÐÐ—ÐÐœÐ˜
# =============================================

def save_order_to_db(user_info, order_data):
    """Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð·Ð°ÐºÐ°Ð· Ð¸ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ Ð² Ð‘Ð”"""
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()

    try:
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
        customer = get_customer(user_info['id'])
        if not customer:
            register_or_update_customer_from_info(user_info)
            customer = get_customer(user_info['id'])

        # Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÐºÑƒÑ€Ñ
        cursor.execute("SELECT rate_rub FROM exchange_rates ORDER BY recorded_at DESC LIMIT 1")
        rate_row = cursor.fetchone()
        exchange_rate = rate_row[0] if rate_row else 12.5

        # Ð’ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°ÐºÐ°Ð·
        cursor.execute("""
            INSERT INTO orders (
                id_customer, total_amount_rub, delivery_address, order_date, exchange_rate_used
            ) VALUES (?, ?, ?, ?, ?)
        """, (
            customer['id_customer'],
            order_data['total'],
            user_info.get('address', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'),
            order_data['timestamp'],
            exchange_rate
        ))
        order_id = cursor.lastrowid

        # Ð’ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸
        for item in order_data['items']:
            subtotal = item['price'] * item['quantity']
            cursor.execute("""
                INSERT INTO order_items (
                    id_order, id_product, product_name, product_price_rub, size, color, quantity, subtotal
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            """, (
                order_id,
                item.get('id_product'),
                item['name'],
                item['price'],
                item.get('size'),
                item.get('color'),
                item['quantity'],
                subtotal
            ))

        conn.commit()
        logger.info("Ð—Ð°ÐºÐ°Ð· #%s ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð² Ð‘Ð”", order_id)
        return order_id

    except Exception as e:
        logger.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°: %s", e)
        conn.rollback()
        return None
    finally:
        conn.close()


def register_or_update_customer_from_info(user_info):
    """Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð¸Ð· Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼Ñ‹"""
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    try:
        cursor.execute("""
            INSERT OR REPLACE INTO customers 
            (telegram_id, full_name, phone, delivery_address, city, username, updated_at)
            VALUES (?, ?, ?, ?, ?, ?, datetime('now', 'localtime'))
            ON CONFLICT(telegram_id) DO UPDATE SET
                full_name = excluded.full_name,
                phone = excluded.phone,
                delivery_address = excluded.delivery_address,
                city = excluded.city,
                username = excluded.username,
                updated_at = excluded.updated_at
        """, (
            user_info['id'],
            user_info.get('name'),
            user_info.get('phone'),
            user_info.get('address'),
            user_info.get('city'),
            user_info.get('username')
        ))
        conn.commit()
    except Exception as e:
        logger.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: %s", e)
    finally:
        conn.close()


def send_admin_notification(user_info, order_data, order_id):
    """ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ"""
    try:
        message = (
            "ðŸ”” ÐÐžÐ’Ð«Ð™ Ð—ÐÐšÐÐ—!\n\n"
            "ðŸ‘¤ ÐšÐ»Ð¸ÐµÐ½Ñ‚:\n"
        )
        message += f"â€¢ Ð˜Ð¼Ñ: {user_info.get('name', user_info.get('first_name', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'))}\n"
        if user_info.get('last_name'):
            message += f"â€¢ Ð¤Ð°Ð¼Ð¸Ð»Ð¸Ñ: {user_info['last_name']}\n"
        message += f"â€¢ Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: {user_info.get('phone', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½')}\n"
        if user_info.get('email'):
            message += f"â€¢ Email: {user_info['email']}\n"
        if user_info.get('address'):
            message += f"â€¢ ÐÐ´Ñ€ÐµÑ: {user_info['address']}\n"
        message += f"â€¢ Telegram ID: {user_info['id']}\n"
        if user_info.get('username'):
            message += f"â€¢ @{user_info['username']}\n"

        message += f"\nðŸ“¦ Ð—Ð°ÐºÐ°Ð· #{order_id}:\n"
        message += f"â€¢ Ð¡ÑƒÐ¼Ð¼Ð°: {order_data['total']}â‚½\n"
        message += f"â€¢ Ð¢Ð¾Ð²Ð°Ñ€Ð¾Ð²: {len(order_data['items'])}\n"
        message += f"â€¢ Ð’Ñ€ÐµÐ¼Ñ: {order_data['timestamp']}\n\n"
        message += "ðŸ“‹ Ð¡Ð¾ÑÑ‚Ð°Ð²:\n"
        for i, item in enumerate(order_data['items'], 1):
            message += f"{i}. {item['name']} - {item['price']}â‚½ x{item['quantity']}\n"

        bot.send_message(ADMIN_ID, message)
        logger.info("Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ñƒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾")

    except Exception as e:
        logger.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ: %s", e)


# =============================================
# ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ˜
# =============================================

@bot.message_handler(commands=['start'])
def start(message):
    logger.info("/start Ð¾Ñ‚ %s", message.from_user.id)
    register_or_update_customer(message)

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add(types.KeyboardButton('ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹Ñ'))

    bot.send_message(
        message.chat.id,
        "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² AI Taobao Assistant!\n\n"
        "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð¸Ð½Ð¸-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ¾Ð¼:",
        reply_markup=markup
    )


@bot.message_handler(func=lambda message: message.text == 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹Ñ')
def open_marketplace(message):
    logger.info("ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐ° %s", message.from_user.id)

    markup = types.InlineKeyboardMarkup()
    web_app = types.WebAppInfo(url='https://beggab.github.io/StoreChina-/')
    button = types.InlineKeyboardButton(text='ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½', web_app=web_app)
    markup.add(button)

    bot.send_message(
        message.chat.id,
        "ðŸ›’ ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½:",
        reply_markup=markup
    )


@bot.message_handler(content_types=['web_app_data'])
def handle_web_app_data(message):
    try:
        logger.info("WEB_APP_DATA Ð¾Ñ‚ %s", message.from_user.id)
        logger.info("Raw data: %s", message.web_app_data.data)

        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ JSON
        try:
            data = json.loads(message.web_app_data.data)
        except json.JSONDecodeError:
            bot.send_message(message.chat.id, "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð½ÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ")
            return

        if not isinstance(data, dict) or data.get('action') != 'checkout':
            bot.send_message(message.chat.id, "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
            return

        user_data = data.get('user', {})
        total = float(data.get('total', 0))
        items = data.get('items', [])
        if not items:
            bot.send_message(message.chat.id, "âŒ ÐšÐ¾Ñ€Ð·Ð¸Ð½Ð° Ð¿ÑƒÑÑ‚Ð°")
            return

        # Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¸Ð· Telegram
        telegram_user_info = {
            'id': message.from_user.id,
            'first_name': message.from_user.first_name,
            'last_name': message.from_user.last_name,
            'username': message.from_user.username
        }
        full_user_info = {**telegram_user_info, **user_data}

        order_data = {
            'items': items,
            'total': round(total, 2),
            'timestamp': datetime.now().strftime('%d.%m.%Y %H:%M:%S')
        }

        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð·Ð°ÐºÐ°Ð·
        order_id = save_order_to_db(full_user_info, order_data)
        if not order_id:
            bot.send_message(message.chat.id, "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°")
            return

        # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð°Ð´Ð¼Ð¸Ð½Ð°
        send_admin_notification(full_user_info, order_data, order_id)

        # ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ
        bot.send_message(
            message.chat.id,
            f"âœ… Ð—Ð°ÐºÐ°Ð· â„–{order_id} Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½!\n\n"
            f"ðŸ’µ Ð¡ÑƒÐ¼Ð¼Ð°: {total}â‚½\n"
            f"ðŸ“¦ Ð¢Ð¾Ð²Ð°Ñ€Ð¾Ð²: {len(items)}\n\n"
            f"ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ ÑÐ²ÑÐ¶ÐµÑ‚ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ."
        )

    except Exception as e:
        logger.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ WebApp: %s", e)
        bot.send_message(message.chat.id, "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð·Ð°ÐºÐ°Ð·Ð°")


# =============================================
# ÐÐ”ÐœÐ˜Ð-ÐšÐžÐœÐÐÐ”Ð«
# =============================================

@bot.message_handler(commands=['orders'])
def show_orders(message):
    if message.from_user.id != ADMIN_ID:
        bot.send_message(message.chat.id, "âŒ Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°")
        return

    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT o.id_order, o.total_amount_rub, o.order_date, c.full_name, c.phone
        FROM orders o
        JOIN customers c ON o.id_customer = c.id_customer
        ORDER BY o.order_date DESC
        LIMIT 10
    """)
    rows = cursor.fetchall()
    conn.close()

    if not rows:
        bot.send_message(message.chat.id, "ðŸ“­ ÐÐµÑ‚ Ð·Ð°ÐºÐ°Ð·Ð¾Ð²")
        return

    text = "ðŸ“¦ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ñ‹:\n\n"
    for row in rows:
        text += f"#{row[0]} | {row[1]}â‚½ | {row[2]}\nðŸ‘¤ {row[3]} | ðŸ“ž {row[4]}\nâž–âž–âž–\n"
    bot.send_message(message.chat.id, text)


@bot.message_handler(commands=['status'])
def status(message):
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM customers")
    total_users = cursor.fetchone()[0]
    cursor.execute("SELECT COUNT(*) FROM orders")
    total_orders = cursor.fetchone()[0]
    conn.close()

    info = (
        f"ðŸ¤– Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð¾Ñ‚Ð°\n"
        f"ðŸ‘¥ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹: {total_users}\n"
        f"ðŸ“¦ Ð—Ð°ÐºÐ°Ð·Ð¾Ð²: {total_orders}\n"
        f"ðŸ•’ Ð’Ñ€ÐµÐ¼Ñ: {datetime.now().strftime('%H:%M:%S')}"
    )
    bot.send_message(message.chat.id, info)


@bot.message_handler(commands=['help'])
def help_command(message):
    help_text = """
ðŸ¤– AI Taobao Assistant - ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ

/start - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°
/help - ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ
/status - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ
/orders - Ð—Ð°ÐºÐ°Ð·Ñ‹ (Ð°Ð´Ð¼Ð¸Ð½)
    """
    bot.send_message(message.chat.id, help_text)


# =============================================
# Ð—ÐÐŸÐ£Ð¡Ðš
# =============================================

if __name__ == '__main__':
    init_db()
    logger.info("=" * 50)
    logger.info("Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½")
    logger.info("ÐÐ´Ð¼Ð¸Ð½ ID: %s", ADMIN_ID)
    logger.info("=" * 50)

    try:
        bot.polling(none_stop=True, interval=1, timeout=30)
    except Exception as e:
        logger.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð¾Ñ‚Ð°: %s", e)
